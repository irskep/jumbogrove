<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/jg/model.js | Jumbo Grove</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-app.css"><link rel="stylesheet" href="./inject/css/0-style.css"><script src="./inject/script/0-jumbogrove.js"></script><script src="./inject/script/0-script.js"></script><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-4517625-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-4517625-7');
</script><meta name="description" content="An interactive fiction game engine"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Jumbo Grove"><meta property="twitter:description" content="An interactive fiction game engine"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/irskep/jumbogrove"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-jumbogrove">jumbogrove</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#jg">jg</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/character.js~Character.html">Character</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/dataui.js~ui.html">ui</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/model.js~model.html">model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/situation.js~Situation.html">Situation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/markdown-it/markdown-it">MarkdownIt</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#jg-gameformat">jg/gameformat</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/gameformat/character.js~character.html">character</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/gameformat/game.js~game.html">game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/jg/gameformat/situation.js~situation.html">situation</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#jg-qualities">jg/qualities</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flag">flag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fudgeAdjective">fudgeAdjective</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-qualities">qualities</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-integer">integer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-namedChoice">namedChoice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nonZeroInteger">nonZeroInteger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onOff">onOff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-raw">raw</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-wordScale">wordScale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-yesNo">yesNo</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/jg/model.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @module model
 * @memberof module:jumbogrove
 */
import _ from &apos;lodash&apos;;
import Character from &apos;./character&apos;;
import Situation from &apos;./situation&apos;;

/**
 * Maintains game state and allows you to make changes to it.
 * 
 * The model object is the primary way for you to interact with Jumbo Grove.
 */
export default class model {
    /**
     * @ignore
     * 
     * @param {object} args Arguments object
     * @param {object[]} args.characters
     * @param {object} args.globalState
     * @param {object[]} args.situations
     * @param {string} args.initialSituation
     */
    constructor(director, {characters, globalState, situations, initialSituation}) {
        /** @ignore */
        this._director = director;
        /** @ignore */
        this._characters = {};
        /** @ignore */
        this._situations = {};
        /** @ignore */
        this._initialSituationId = initialSituation;

        // These will be injected when the UI is bound to the director
        /** @ignore */
        this.navHeaderHTML = null;
        /** @ignore */
        this.asideHeaderHTML = null;

        /**
         * The situation currently being run, or last seen by the user.
         * @member
         * @type {Situation|null} */
        this.currentSituation = null;

        characters.forEach((c) =&gt; this._characters[c.id] = new Character(c));

        /**
         * Store all non-character game state here; **Must be JSON-safe!** You may mutate
         * this object freely as long as it is safe to convert it to JSON and back.
         * @member
         * 
         */
        this.globalState = _.cloneDeep(globalState);

        /**
         * The character with ID `&apos;player&apos;`.
         * @member
         * @type {Character|null} */
        this.player = this.character(&apos;player&apos;) || null;

        situations.forEach((s) =&gt; {
            if (this._situations[s.id]) throw new Error(`Duplicate situation id: ${s.id}`);
            this._situations[s.id] = new Situation(s);
        });

        /**
         * List of all characters in the game.
         * @member
         * @type {Character[]} */
        this.allCharacters = _.sortBy(Object.values(this._characters), ({priority}) =&gt; priority || 0);
    }

    /**
     * Follow a Jumbo Grove link (`@situation-id` or `&gt;action`).
     * @param {command} string
     */
    do(...args) {
        return this._director.handleCommandString(...args);
    }

    /**
     * Go to the given sitaution (no `@`).
     * @param {string} id
     */
    goTo(...args) {
        return this._director.goTo(...args);
    }

    /**
     * Returns true iff the given string can be handled by Jumbo Grove (rather than being a normal HTML link)
     * @param {string} string A string to check
     * @returns {Boolean} 
     */
    isManagedLink(...args) {
        return this._director.isManagedLink(...args);
    }

    /**
     * Add arbitrary methods to the model object. Since the model is passed to
     * all callbacks, this is a good way to make convenient functions accessible.
     * 
     * Also, anything you pass here will also be provided to the template context.
     * 
     * @param {Map&lt;string, function&gt;} fns Mapping of name to function
     */
    extend(fns) {
        Object.assign(this, fns);
    }

    /**
     * @ignore
     */
    toSave() {
        return {
            globalState: this.globalState,
            currentSituationId: this.currentSituation ? this.currentSituation.id : null,
            characters: this.allCharacters.map((c) =&gt; c.toSave()),
            situations: Object.values(this._situations).map((s) =&gt; s.toSave()),
        };
    }

    /**
     * @ignore
     */
    loadSave(obj) {
        this.globalState = obj.globalState;
        this.currentSituation = this._situations[obj.currentSituationId] || null;
        for (const data of obj.characters) {
            this.character(data.id).loadSave(data);
        }
        for (const s of obj.situations) {
            this.situation(s.id).loadSave(s);
        }
    }

    /**
     * @ignore
     */
    toString() {
        return `Model(globalState=${this.globalState}, characters=${this.characters})`;
    }

    /**
     * Looks up a situation by ID. Prints an error to the console if there isn&apos;t one.
     * @param {string} id 
     * @returns {Situation|null} Situation with the given ID
     */
    situation(id) {
        if (!this._situations[id]) console.error(`Situation not found: ${id}`);
        return this._situations[id];
    }

    /**
     * Returns a list of all situations matching the given ID (`foo`) or tag (`#foo`).
     * @param {string} idOrTag 
     * @returns {Situation[]}
     */
    situations(idOrTag) {
        if (idOrTag.startsWith(&quot;#&quot;)) {
            const tag = idOrTag.slice(1);
            return Object.values(this._situations)
                .filter((s) =&gt; s.tags.indexOf(tag) !== -1);
        } else {
            return [this._situations[idOrTag]];
        }
    }

    /**
     * Look up a character by ID. Returns `undefined` if there isn&apos;t one.
     * @param {string} id 
     */
    character(id) {
        return this._characters[id];
    }

    /**
     * Return a random number 0-1. Currently this just calls `Math.random()`, but
     * in the future it might do something fancy with seeds that let you avoid
     * save scumming.
     */
    random() {
        return Math.random();
    }

    /**
     * Given a set of situations, do some smart stuff and return the situations
     * that match the filter.
     * 
     * 1. Filter out all situations for which `situation.getCanSee(model, model.currentSituation, situation)` returns `false`.
     * 2. Find the highest priority that matches a list of situations at least as big as `atLeast`.
     * 3. If there are more situations left than there are `atMost`, randomly remove some.
     * 4. Sort by `situation.displayOrder`.
     * 
     * Note that it is possible to end up with a list of situations for which `getCanChoose()` returned `false` for all of them!
     * 
     * This logic has been shamelessly stolen from Undum.
     * 
     * @param {string[]} arrayOfSituationIdsOrTags Like `[&apos;one-situation&apos;, &apos;#situations-matching-this-tag&apos;]`
     * @param {number} atLeast 
     * @param {number} atMost 
     */
    interpretChoices(arrayOfSituationIdsOrTags, atLeast = 0, atMost = Number.MAX_VALUE) {
        const host = this.currentSituation;
        if (host.debugChoices) debugger;  // eslint-disable-line no-debugger
        const situations = [].concat.apply(
            [], arrayOfSituationIdsOrTags.map(this.situations.bind(this)));
        // remove invisible situations
        const visibleSituations = situations.filter((s) =&gt; s.getCanSee(this, host, s));

        // sort by display order
        const sortedSituations = _.sortBy(
            visibleSituations, (s) =&gt; s.getDisplayOrder(this, host));

        // index by priority; figure out what priorities are being used
        const sortedSituationsByPriority = {};
        const prioritiesSeen = [];
        for (const s of sortedSituations) {
            const p = s.getPriority(this, host);
            if (!sortedSituationsByPriority[p]) sortedSituationsByPriority[p] = [];
            sortedSituationsByPriority[p].push(s);
            prioritiesSeen.push(p);
        }

        // figure out what priority we want to use (only one!)
        let chosenPriority = Number.MAX_VALUE;
        for (const p of _.uniq(prioritiesSeen.sort().reverse())) {
            if (sortedSituationsByPriority[p].length &gt;= atLeast) {
                chosenPriority = p;
                break;
            }
        }
        let chosenSituations = sortedSituationsByPriority[chosenPriority];
        if (!chosenSituations) {
            return [];  // Uh oh!
        }

        // Remove random array items until we are under the limit
        while (chosenSituations.length &gt; atMost) {
            const i = Math.floor(this.random() * chosenSituations.length);
            chosenSituations.splice(i, 1);
        }

        // return the chosen situations and provide more info for each
        const allChoices = chosenSituations.map((s) =&gt; {
            return {
                situationId: s.id,
                text: s.getOptionText(this, host),
                isEnabled: s.getCanChoose(this, host),
            };
        });
        return allChoices.filter(({isEnabled}) =&gt; isEnabled).concat(allChoices.filter(({isEnabled}) =&gt; !isEnabled));
    }

    /**
     * Given an array of tags or situation IDs (can be both in the same array),
     * present the relevant choices in the transcript using the logic in
     * {@link model.interpretChoices}, then go to the situation chosen by the
     * player.
     * @param {string[]} arrayOfSituationIdsOrTags Array of strings containing either `#tags` or `situation-ids`.
     */
    presentChoices(arrayOfSituationIdsOrTags) {
        this._director.ui.presentChoices(arrayOfSituationIdsOrTags)
            .then(({situationId, itemId}) =&gt; {
                this.do(`@${situationId}`, itemId, &apos;fake&apos;);
            });
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
